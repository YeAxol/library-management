<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Entries</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="loading-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999;">
        <div class="spinner" style="border:8px solid #f3f3f3; border-top:8px solid #3498db; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;"></div>
    </div>
    <style>
    @keyframes spin {
        0% { transform: rotate(0deg);}
        100% { transform: rotate(360deg);}
    }
    </style>

    {% include 'header.html' %}
    <main>
        <h2>Manage Entries</h2>
        <div class="entry-form">
                {% include 'partials/album_form.html' %}
        </div>
    </main>
    <script>
            $(document).ready(function() {
                // Delegate for both submit and update buttons
                $('.entry-form').on('click', '#submit-button, #update-button', function(event) {
                    event.preventDefault();
                    let form = $(this).closest('form')[0];
                    let formDataObj = {};
                    let formData = new FormData(form);

                    // Build formDataObj from FormData
                    for (let [key, value] of formData.entries()) {
                        if (key.endsWith('[]')) {
                            let cleanKey = key.slice(0, -2);
                            if (!formDataObj[cleanKey]) formDataObj[cleanKey] = [];
                            formDataObj[cleanKey].push(value);
                        } else {
                            if (formDataObj[key]) {
                                if (!Array.isArray(formDataObj[key])) {
                                    formDataObj[key] = [formDataObj[key]];
                                }
                                formDataObj[key].push(value);
                            } else {
                                formDataObj[key] = value;
                            }
                        }
                    }

                    // Ensure artistNames and mediums are arrays (split by comma, trim whitespace)
                    if (formDataObj['artist_names']) {
                        if (Array.isArray(formDataObj['artist_names'])) {
                            formDataObj['artist_names'] = formDataObj['artist_names'].flatMap(val =>
                                val.split(',').map(s => s.trim()).filter(Boolean)
                            );
                        } else {
                            formDataObj['artist_names'] = formDataObj['artist_names'].split(',').map(s => s.trim()).filter(Boolean);
                        }
                    }
                    if (formDataObj['mediums']) {
                        if (Array.isArray(formDataObj['mediums'])) {
                            formDataObj['mediums'] = formDataObj['mediums'].flatMap(val =>
                                val.split(',').map(s => s.trim()).filter(Boolean)
                            );
                        } else {
                            formDataObj['mediums'] = formDataObj['mediums'].split(',').map(s => s.trim()).filter(Boolean);
                        }
                    }
                    if (formDataObj['track_artists']) {
                        if (Array.isArray(formDataObj['track_artists'])) {
                            formDataObj['track_artists'] = formDataObj['track_artists'].flatMap(val =>
                                val.split(',').map(s => s.trim()).filter(Boolean)
                            );
                        } else {
                            formDataObj['track_artists'] = formDataObj['track_artists'].split(',').map(s => s.trim()).filter(Boolean);
                        }
                    }

                    // Overwrite track_fcc_clean with an array of booleans for each track
                    let fccCleanArr = [];
                    $(form).find('input[name="track_fcc_clean[]"]').each(function() {
                        fccCleanArr.push($(this).is(':checked'));
                    });
                    formDataObj['track_fcc_clean'] = fccCleanArr;

                    // Get the base64 image from the rendered <img>
                    let imgSrc = $('#album-image').attr('src');
                    if (imgSrc && imgSrc.startsWith('data:image')) {
                        formDataObj['image'] = imgSrc;
                    }

                    // Add edit: true if update-button was clicked
                    if (event.target.id === 'update-button') {
                        formDataObj['edit'] = true;
                    }

                    $.ajax({
                        url: "{{ url_for('manage_library') }}",
                        type: 'POST',
                        data: JSON.stringify(formDataObj),
                        contentType: 'application/json',
                        success: function(response) {
                            if (response.error) {
                                alert(response.error);
                            } else {
                                window.location.href = "{{ url_for('home') }}";
                            }
                        },
                        error: function(xhr, status, error) {
                            alert("An error occurred: " + error);
                        }
                    });
                });
            $('.entry-form').on('click', '#delete-button', function(event) {
                event.preventDefault();
                if (confirm('Are you sure you want to delete this entry?')) {
                    // Get the album_uuid from a hidden input or JS variable
                    const album_uuid = $('input[name="album_uuid"]').val();
                    if (album_uuid) {
                        window.location.href = `/delete_entry/${album_uuid}`;
                    } else {
                        alert('Album UUID not found.');
                    }
                }
            });
            $('.entry-form').on('click', '#cancel-button', function(event) {
                event.preventDefault();
                window.location.href = "{{ url_for('home') }}";
            });

            $('.entry-form').on('click', '#add-track', function() {
                $('#track-table tbody').append(`
                    <tr>
                        <td><input type="text" name="track_name[]" placeholder="Track Name"></td>
                        <td><input type="text" name="track_artists[]" placeholder="Artist(s)"></td>
                        <td><input type="text" name="track_duration[]" placeholder="Duration"></td>
                        <td><input type="checkbox" name="track_fcc_clean[]"></td>
                    </tr>
                `);
            });

            $('.entry-form').on('click', '#remove-track', function() {
                const $rows = $('#track-table tbody tr');
                if ($rows.length > 0) {
                    $rows.last().remove();
                }
            });

            $('#fetch-upc').click(function(event) {
                event.preventDefault();
                const upc = $('#upc').val();
                if (upc) {
                    $('#loading-spinner').show();
                    $.post("{{ url_for('fetch_upc') }}", { upc: upc }, function(data) {
                        $('#loading-spinner').hide();
                        if (data.error) {
                            alert(data.error);
                        } else {
                            $('.entry-form').html(data);
                        }
                    }).fail(function() {
                        $('#loading-spinner').hide();
                        alert("An error occurred while fetching UPC.");
                    });
                }
            });
            $('#fetch-discogs').click(function(event) {
                event.preventDefault();
                const discogsrelease = $('#discogsrelease').val();
                if (discogsrelease) {
                    $('#loading-spinner').show();
                    $.post("{{ url_for('fetch_discogs') }}", { discogs_id: discogsrelease }, function(data) {
                        $('#loading-spinner').hide();
                        if (data.error) {
                            alert(data.error);
                        } else {
                            $('.entry-form').html(data);
                        }
                    }).fail(function() {
                        $('#loading-spinner').hide();
                        alert("An error occurred while fetching Discogs Release.");
                    });
                }
            });
            // Use event delegation for dynamically replaced image inputs
            $(document).on('change', '#image', function(event) {
                const [file] = event.target.files;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#album-image').attr('src', e.target.result).show();
                    }
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
</body>
</html>